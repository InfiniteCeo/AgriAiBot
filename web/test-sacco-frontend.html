<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test SACCO Frontend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">SACCO Frontend Test</h1>
        
        <!-- Authentication Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Authentication</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium mb-2">Register Test User</h3>
                    <button onclick="registerTestUser()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Register User
                    </button>
                </div>
                <div>
                    <h3 class="font-medium mb-2">Current User</h3>
                    <div id="currentUser" class="text-sm text-gray-600">Not logged in</div>
                </div>
            </div>
        </div>
        
        <!-- SACCO Creation Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">SACCO Creation Test</h2>
            
            <!-- Test Buttons -->
            <div class="flex space-x-4 mb-6">
                <button onclick="testCreateSACCO()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-plus mr-2"></i>Test Create SACCO
                </button>
                <button onclick="showCreateModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-window-maximize mr-2"></i>Test Modal
                </button>
                <button onclick="loadSACCOs()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-refresh mr-2"></i>Load SACCOs
                </button>
            </div>
            
            <!-- Results -->
            <div id="results" class="bg-gray-100 p-4 rounded min-h-32">
                <p class="text-gray-600">Test results will appear here...</p>
            </div>
        </div>
        
        <!-- SACCO List -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Available SACCOs</h2>
            <div id="saccoList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-gray-600">No SACCOs loaded yet...</p>
            </div>
        </div>
    </div>

    <!-- Test Modal -->
    <div id="testModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Test Modal</h3>
                <button onclick="hideCreateModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="mb-4">This is a test modal to verify modal functionality works.</p>
            <div class="flex space-x-3">
                <button onclick="hideCreateModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded">
                    Close
                </button>
                <button onclick="createSACCOFromModal()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">
                    Create Test SACCO
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentToken = null;
        let currentUser = null;

        // Register a test user
        async function registerTestUser() {
            try {
                log('Registering test user...');
                
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: `testuser${Date.now()}@example.com`,
                        password: 'testpass123',
                        phone: `+25470000${Math.floor(Math.random() * 10000)}`,
                        name: 'Test User',
                        user_type: 'farmer',
                        location: 'Nairobi'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentToken = data.token;
                    currentUser = data.user;
                    document.getElementById('currentUser').textContent = `${data.user.name} (${data.user.email})`;
                    log('✅ User registered successfully!');
                } else {
                    log(`❌ Registration failed: ${data.message}`);
                }
            } catch (error) {
                log(`❌ Registration error: ${error.message}`);
            }
        }

        // Test SACCO creation
        async function testCreateSACCO() {
            if (!currentToken) {
                log('❌ Please register a user first');
                return;
            }
            
            try {
                log('Creating test SACCO...');
                
                const response = await fetch('/api/sacco', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        name: `Test SACCO ${Date.now()}`,
                        region: 'Nairobi',
                        description: 'A test SACCO group created from frontend test',
                        member_limit: 50
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`✅ SACCO created successfully: ${data.sacco.name}`);
                    log(`   ID: ${data.sacco.id}`);
                    log(`   Region: ${data.sacco.region}`);
                    loadSACCOs(); // Refresh the list
                } else {
                    log(`❌ SACCO creation failed: ${data.message}`);
                }
            } catch (error) {
                log(`❌ SACCO creation error: ${error.message}`);
            }
        }

        // Load SACCOs
        async function loadSACCOs() {
            if (!currentToken) {
                log('❌ Please register a user first');
                return;
            }
            
            try {
                log('Loading SACCOs...');
                
                const response = await fetch('/api/sacco', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`✅ Loaded ${data.saccos.length} SACCOs`);
                    displaySACCOs(data.saccos);
                } else {
                    log(`❌ Failed to load SACCOs: ${data.message}`);
                }
            } catch (error) {
                log(`❌ Load SACCOs error: ${error.message}`);
            }
        }

        // Display SACCOs
        function displaySACCOs(saccos) {
            const container = document.getElementById('saccoList');
            
            if (saccos.length === 0) {
                container.innerHTML = '<p class="text-gray-600">No SACCOs found</p>';
                return;
            }
            
            container.innerHTML = saccos.map(sacco => `
                <div class="bg-gray-50 rounded-lg p-4 border">
                    <h3 class="font-semibold text-gray-800">${sacco.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">${sacco.description || 'No description'}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span><i class="fas fa-map-marker-alt mr-1"></i>${sacco.region}</span>
                        <span><i class="fas fa-users mr-1"></i>${sacco.member_count || 0}/${sacco.member_limit}</span>
                    </div>
                </div>
            `).join('');
        }

        // Show modal
        function showCreateModal() {
            log('Opening test modal...');
            const modal = document.getElementById('testModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Hide modal
        function hideCreateModal() {
            log('Closing test modal...');
            const modal = document.getElementById('testModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Create SACCO from modal
        function createSACCOFromModal() {
            log('Creating SACCO from modal...');
            hideCreateModal();
            testCreateSACCO();
        }

        // Logging function
        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="text-sm mb-1">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        // Clear results
        function clearResults() {
            document.getElementById('results').innerHTML = '<p class="text-gray-600">Test results cleared...</p>';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Frontend test page loaded successfully');
        });
    </script>
</body>
</html>